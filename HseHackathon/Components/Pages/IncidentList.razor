@page "/"
@using HseHackathon.Entities
@using HseHackathon.Services
@inject IncidentService IncidentService
@inject IncidentTypeService IncidentTypeService
@inject NavigationManager NavigationManager

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="display-5 fw-bold">
                <i class="bi bi-shield-exclamation"></i> HSE Incident Reports
            </h1>
            <p class="text-muted">Quick access to HSE incident and near miss reports</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="/incident-form" class="btn btn-primary btn-lg">
                <i class="bi bi-plus-circle"></i> New Report
            </a>
        </div>
    </div>

    <!-- Filter and Search Section -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="input-group">
                <span class="input-group-text bg-white">
                    <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control" placeholder="Search by location..."
                    @bind="searchTerm" @bind:event="oninput" @onkeyup="OnSearchChanged">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="selectedStatus">
                <option value="">All Status</option>
                <option value="@IncidentStatus.Draft.ToString()">Draft</option>
                <option value="@IncidentStatus.Submitted.ToString()">Submitted</option>
                <option value="@IncidentStatus.Reviewed.ToString()">Reviewed</option>
                <option value="@IncidentStatus.Closed.ToString()">Closed</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" @bind="selectedIncidentType">
                <option value="">All Types</option>
                @foreach (var type in incidentTypes)
                {
                    <option value="@type.Id.ToString()">@type.Name</option>
                }
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-outline-secondary w-100" @onclick="ResetFilters">
                <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h6 class="card-title text-muted">Total Reports</h6>
                    <h3 class="fw-bold">@totalIncidents</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h6 class="card-title text-muted">Submitted</h6>
                    <h3 class="fw-bold text-primary">@submittedCount</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h6 class="card-title text-muted">Reviewed</h6>
                    <h3 class="fw-bold text-info">@reviewedCount</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h6 class="card-title text-muted">Pending Action</h6>
                    <h3 class="fw-bold text-warning">@draftCount</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Incidents Table -->
    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading incident reports...</p>
        </div>
    }
    else if (filteredIncidents == null || filteredIncidents.Count == 0)
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle"></i> <strong>No incidents found.</strong>
            @if (string.IsNullOrEmpty(searchTerm) && string.IsNullOrEmpty(selectedStatus) && string.IsNullOrEmpty(selectedIncidentType))
            {
                <span>Start by <a href="/incident-form" class="alert-link">creating a new incident report</a>.</span>
            }
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover border align-middle">
                <thead class="table-light">
                    <tr>
                        <th>
                            <button class="btn btn-link text-decoration-none" @onclick="@(() => SortBy("Date"))">
                                Date/Time @GetSortIcon("Date")
                            </button>
                        </th>
                        <th>
                            <button class="btn btn-link text-decoration-none" @onclick="@(() => SortBy("Location"))">
                                Location @GetSortIcon("Location")
                            </button>
                        </th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Reporter</th>
                        <th>
                            <button class="btn btn-link text-decoration-none" @onclick="@(() => SortBy("Status"))">
                                Status @GetSortIcon("Status")
                            </button>
                        </th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var incident in filteredIncidents)
                    {
                        <tr>
                            <td>
                                <small class="text-muted">
                                    @incident.DateTimeReported.ToString("dd/MM/yyyy HH:mm")
                                </small>
                            </td>
                            <td>
                                <strong>@incident.Location</strong>
                            </td>
                            <td>
                                <span class="badge bg-secondary">@incident.IncidentType?.Name</span>
                            </td>
                            <td>
                                <small>@(incident.Description.Length > 50 ? incident.Description.Substring(0, 50) + "..." : incident.Description)</small>
                            </td>
                            <td>
                                <small>@incident.ReportedByUser?.FullName</small>
                            </td>
                            <td>
                                @switch (incident.Status)
                                {
                                    case IncidentStatus.Draft:
                                        <span class="badge bg-secondary">Draft</span>
                                        break;
                                    case IncidentStatus.Submitted:
                                        <span class="badge bg-primary">Submitted</span>
                                        break;
                                    case IncidentStatus.Reviewed:
                                        <span class="badge bg-info">Reviewed</span>
                                        break;
                                    case IncidentStatus.Closed:
                                        <span class="badge bg-success">Closed</span>
                                        break;
                                }
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <a href="/incident-detail/@incident.Id" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> View
                                    </a>
                                    @if (incident.Status == IncidentStatus.Draft)
                                    {
                                        <a href="/incident-form/@incident.Id" class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Incident> incidents = new();
    private List<Incident> filteredIncidents = new();
    private List<IncidentType> incidentTypes = new();
    private bool isLoading = true;
    private string searchTerm = string.Empty;
    private string selectedStatus = string.Empty;
    private string selectedIncidentType = string.Empty;
    private string sortBy = "Date";
    private bool sortAscending = false;

    private int totalIncidents => incidents.Count;
    private int draftCount => incidents.Count(i => i.Status == IncidentStatus.Draft);
    private int submittedCount => incidents.Count(i => i.Status == IncidentStatus.Submitted);
    private int reviewedCount => incidents.Count(i => i.Status == IncidentStatus.Reviewed);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            incidents = await IncidentService.GetAllIncidentsAsync();
            incidentTypes = await IncidentTypeService.GetAllIncidentTypesAsync();
            ApplyFilters();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ApplyFilters()
    {
        filteredIncidents = incidents.Where(i =>
        {
            var matchesSearch = string.IsNullOrEmpty(searchTerm) || 
                i.Location.Contains(searchTerm, StringComparison.OrdinalIgnoreCase);
            
            var matchesStatus = string.IsNullOrEmpty(selectedStatus) || 
                i.Status.ToString() == selectedStatus;
            
            var matchesType = string.IsNullOrEmpty(selectedIncidentType) || 
                i.IncidentTypeId.ToString() == selectedIncidentType;

            return matchesSearch && matchesStatus && matchesType;
        }).ToList();

        ApplySorting();
    }

    private void ApplySorting()
    {
        filteredIncidents = sortBy switch
        {
            "Date" => sortAscending ? 
                filteredIncidents.OrderBy(i => i.DateTimeReported).ToList() :
                filteredIncidents.OrderByDescending(i => i.DateTimeReported).ToList(),
            "Location" => sortAscending ?
                filteredIncidents.OrderBy(i => i.Location).ToList() :
                filteredIncidents.OrderByDescending(i => i.Location).ToList(),
            "Status" => sortAscending ?
                filteredIncidents.OrderBy(i => i.Status).ToList() :
                filteredIncidents.OrderByDescending(i => i.Status).ToList(),
            _ => filteredIncidents
        };
    }

    private void SortBy(string column)
    {
        if (sortBy == column)
            sortAscending = !sortAscending;
        else
        {
            sortBy = column;
            sortAscending = false;
        }

        ApplySorting();
    }

    private string GetSortIcon(string column)
    {
        if (sortBy != column)
            return "↕️";
        return sortAscending ? "↑" : "↓";
    }

    private void OnSearchChanged()
    {
        ApplyFilters();
    }

    private void OnFilterChanged()
    {
        ApplyFilters();
    }

    private void ResetFilters()
    {
        searchTerm = string.Empty;
        selectedStatus = string.Empty;
        selectedIncidentType = string.Empty;
        sortBy = "Date";
        sortAscending = false;
        ApplyFilters();
    }
}
